<!DOCTYPE html>

<head>
	<title>MQTT Client with google charts</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

	<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
	<script src="https://www.gstatic.com/charts/loader.js" type="text/javascript">/* global google */</script>
	<script src="js/util.js" type="text/javascript"></script>
	<script type="text/javascript">
		// On charge le widget google
		google.charts.load('current', { 'packages': ['gauge'] });
		google.charts.setOnLoadCallback(drawChart);
		// Connection au broker mqtt
		window.connection = connectionInfo(location);

		function drawChart() {
			// Initialisation du widget
			var data = google.visualization.arrayToDataTable([
				['Label', 'Value'],
				['Knob', 80]
			]);

			var options = {
				max: 1000,
				width: 400, height: 120,
				redFrom: 900, redTo: 1000,
				yellowFrom: 750, yellowTo: 900,
				minorTicks: 5
			};

			var chart = new google.visualization.Gauge(document.getElementById('chart_div'));
			chart.draw(data, options);

			const client = new Paho.MQTT.Client(window.connection.host, window.connection.port, window.connection.clientID);
			client.onConnectionLost = onConnectionLost;
			client.onMessageArrived = onMessageArrived;
			client.connect({ onSuccess: onConnect });

			function onConnect() {
				// Once a connection has been made, make a subscription 
				console.log("Connected, subscribing.");
				client.subscribe(connection.topic);
			}

			function onConnectionLost(responseObject) {
				if (responseObject.errorCode !== 0)
					console.log("onConnectionLost:" + responseObject.errorMessage);
			}

			function onMessageArrived(message) {
				var payLoad = message.payloadString;
				// DÃ©coder le message JSON en objet javascript
				var receivedMessage = JSON.parse(payLoad)
				console.log("Message arrived, topic:" + message.destinationName);
				console.log(receivedMessage)
				var knobValue = receivedMessage.measurement;
				if (!isNaN(knobValue) && (0 <= knobValue) && (1000 >= knobValue)) {
					data.setValue(0, 1, knobValue);
					chart.draw(data, options);
				}
			}
		}

	</script>
</head>

<body>
	<h1>MQTT client whith Google charts visualization</h1>
	This client connects to the MQTT server at:
	<pre><script> document.write(window.connection.host);</script></pre><br>
	and subscribes to the topic:
	<pre><script> document.write(window.connection.topic);</script></pre><br>
	Format des messages :
	<pre>{"roomId":1,"sensorType":"typeOfSensor","measurement":1000}</pre><br>
	Publish value to :
	<pre><script> document.write(window.connection.topic);</script>, e.g.</pre><br>
	<pre>mosquitto_pub -h <script> document.write(window.connection.host);</script> -p <script> document.write(window.connection.port);</script> -t <script> document.write(window.connection.topic);</script> -m "{\"roomId\":1, \"sensorType\": \"typeOfSensor\", \"measurement\":1000}"</pre>
	<br>
	or use the web client at : <a href="http://www.hivemq.com/demos/websocket-client/"
		target="_blank">http://www.hivemq.com/demos/websocket-client/</a>
	<hr>
	<ul>
		<li><a href="https://developers.google.com/chart/interactive/docs/gallery">Google charts documentation</a></li>
		<li><a href="http://www.eclipse.org/paho/files/jsdoc/index.html">javascript MQTT documentation</a></li>
	</ul>

	<div id="chart_div" style="width: 400px; height: 120px;"></div>
</body>